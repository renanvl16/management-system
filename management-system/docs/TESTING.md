# üß™ Guia Completo de Testes

## üéØ Estrat√©gia de Testes

O sistema implementa uma **pir√¢mide de testes** completa:

```
                    üî∫ E2E Tests
                   /            \
                  /   üß™ API      \
                 /    Tests       \
                /________________\
               /                  \
              /   üîß Integration   \
             /      Tests          \
            /______________________\
           /                        \
          /     üèóÔ∏è Unit Tests        \
         /        (70%)              \
        /__________________________\
```

## 1Ô∏è‚É£ Testes Unit√°rios

### Executar Testes Unit√°rios
```bash
# Store Service
cd store-service
mvn test

# Central Service
cd central-inventory-service
mvn test

# Executar com cobertura
mvn clean test jacoco:report

# Visualizar relat√≥rio
open target/site/jacoco/index.html
```

### Exemplo de Teste de Dom√≠nio
```java
@ExtendWith(MockitoExtension.class)
class InventoryDomainServiceTest {
    
    @Test
    void shouldReserveProductWhenAvailable() {
        // Given
        var product = Product.builder()
            .sku("NOTEBOOK-001")
            .quantity(10)
            .reservedQuantity(2)
            .build();
            
        // When
        var result = inventoryService.reserveProduct(product, 3);
        
        // Then
        assertThat(result.isSuccess()).isTrue();
        assertThat(product.getAvailableQuantity()).isEqualTo(5);
    }
}
```

## 2Ô∏è‚É£ Testes de Integra√ß√£o

### Executar com TestContainers
```bash
# Testes de integra√ß√£o (requer Docker)
cd store-service
mvn verify -Pintegration-tests

# Profile espec√≠fico para integra√ß√£o
mvn test -Pintegration-tests
```

### Exemplo com TestContainers
```java
@SpringBootTest(webEnvironment = RANDOM_PORT)
@Testcontainers
class StoreServiceIntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15-alpine")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");

    @Container
    static GenericContainer<?> redis = new GenericContainer<>("redis:7.2-alpine")
            .withExposedPorts(6379);

    @Test
    void shouldSearchProductsSuccessfully() {
        // Given
        var storeId = "STORE-001";
        
        // When
        var response = restTemplate.getForEntity(
            "/api/v1/store/{storeId}/inventory/products", 
            ProductListResponse.class, 
            storeId
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getProducts()).isNotEmpty();
    }
}
```

## 3Ô∏è‚É£ Testes de API

### Scripts Automatizados
```bash
# Executar teste b√°sico
./scripts/test-basic.sh

# Teste completo de funcionalidades
./scripts/test-complete.sh

# Teste de resili√™ncia e DLQ
./scripts/test-resilience.sh

# Teste de concorr√™ncia
./scripts/test-concurrency.sh
```

### Teste Manual com cURL
```bash
# 1. Health Check
curl -s http://localhost:8081/store-service/actuator/health | jq

# 2. Listar produtos
curl -s "http://localhost:8081/api/v1/store/STORE-001/inventory/products" | jq

# 3. Reservar produto
curl -X POST "http://localhost:8081/api/v1/store/STORE-001/inventory/products/NOTEBOOK-001/reserve" \
  -H "Content-Type: application/json" \
  -d '{
    "quantity": 2,
    "customerId": "customer-123",
    "reservationDuration": "PT30M"
  }' | jq '.reservationId'

# 4. Confirmar reserva (usar reservationId do passo anterior)
curl -X POST "http://localhost:8081/api/v1/store/STORE-001/inventory/products/NOTEBOOK-001/commit" \
  -H "Content-Type: application/json" \
  -d '{
    "reservationId": "RESERVATION_ID_AQUI",
    "customerId": "customer-123"
  }' | jq

# 5. Verificar invent√°rio global
curl -s "http://localhost:8082/api/v1/inventory/global/NOTEBOOK-001" | jq
```

## 4Ô∏è‚É£ Testes de Resili√™ncia (DLQ)

### Script de Teste de Resili√™ncia
```bash
#!/bin/bash
# Testar sistema de DLQ e resili√™ncia

echo "üõ°Ô∏è Testando Sistema de Resili√™ncia..."

# 1. Parar Kafka temporariamente
echo "‚è∏Ô∏è  Parando Kafka..."
docker-compose stop kafka

# 2. Fazer opera√ß√µes que devem ir para DLQ
echo "üì§ Enviando eventos para DLQ..."
curl -X PUT "http://localhost:8081/api/v1/store/STORE-001/inventory/products/KEYBOARD-001/quantity" \
  -H "Content-Type: application/json" \
  -d '{"newQuantity": 50}'

# 3. Verificar DLQ
echo "üìä Verificando estat√≠sticas do DLQ..."
curl -s "http://localhost:8081/api/v1/admin/dlq/stats" | jq

# 4. Religar Kafka
echo "‚ñ∂Ô∏è  Religando Kafka..."
docker-compose start kafka
sleep 30

# 5. Processar fila DLQ
echo "üîÑ Processando fila DLQ..."
curl -X POST "http://localhost:8081/api/v1/admin/dlq/process-queue"

# 6. Verificar se eventos foram processados
echo "‚úÖ Verificando processamento..."
curl -s "http://localhost:8081/api/v1/admin/dlq/stats" | jq
```

## 5Ô∏è‚É£ Testes de Concorr√™ncia

### Teste de Concorr√™ncia Distribu√≠da
```bash
#!/bin/bash
# Teste de concorr√™ncia com m√∫ltiplas lojas

echo "‚öôÔ∏è Testando Controle de Concorr√™ncia..."

# Fun√ß√£o para simular atualiza√ß√£o concorrente
test_concurrent_update() {
    local store_id=$1
    local product_sku=$2
    local new_quantity=$3
    
    curl -X PUT "http://localhost:8081/api/v1/store/${store_id}/inventory/products/${product_sku}/quantity" \
      -H "Content-Type: application/json" \
      -d "{\"newQuantity\": ${new_quantity}}" \
      -w "%{http_code}\n" -o /dev/null -s
}

# Executar 20 requisi√ß√µes concorrentes para 5 lojas diferentes
echo "üöÄ Executando 100 requisi√ß√µes concorrentes..."
for i in {1..5}; do
    for j in {1..20}; do
        test_concurrent_update "STORE-00${i}" "LAPTOP-001" $((50 + j)) &
    done
done

# Aguardar todas as requisi√ß√µes terminarem
wait

# Verificar resultados
echo "üìä Verificando resultados de concorr√™ncia..."
curl -s "http://localhost:8082/api/v1/inventory/metrics/versioning" | jq
```

## 6Ô∏è‚É£ Testes BDD (Cucumber)

### Executar Testes BDD
```bash
# Testes comportamentais
cd store-service
mvn test -Dcucumber.options="--tags @inventory"

# Relat√≥rio HTML
mvn test -Dcucumber.options="--plugin html:target/cucumber-reports"
```

### Exemplo de Feature
```gherkin
# src/test/resources/features/inventory.feature
Feature: Gest√£o de Invent√°rio da Loja

  Background:
    Given uma loja "STORE-001" com os seguintes produtos:
      | sku         | name              | quantity | price  |
      | NOTEBOOK-001| Notebook Dell     | 10       | 2499.99|
      | MOUSE-001   | Mouse Logitech    | 25       | 349.99 |

  @inventory @search
  Scenario: Buscar produtos dispon√≠veis
    When eu busco produtos da loja "STORE-001"
    Then eu devo receber uma lista com 2 produtos
    And o produto "NOTEBOOK-001" deve estar dispon√≠vel

  @inventory @reserve
  Scenario: Reservar produto com estoque dispon√≠vel
    When eu reservo 3 unidades do produto "NOTEBOOK-001" da loja "STORE-001"
    Then a reserva deve ser bem-sucedida
    And o estoque dispon√≠vel deve ser 7 unidades
    And um evento de reserva deve ser publicado no Kafka
```

## 7Ô∏è‚É£ Testes de Performance

### JMeter Load Testing
```bash
# Instalar JMeter
wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
tar -xzf apache-jmeter-5.6.2.tgz

# Executar teste de carga
./apache-jmeter-5.6.2/bin/jmeter -n -t tests/load-test.jmx -l results.jtl

# Gerar relat√≥rio
./apache-jmeter-5.6.2/bin/jmeter -g results.jtl -o report/
```

### M√©tricas de Performance Esperadas
- **Lat√™ncia P95**: < 100ms para opera√ß√µes locais
- **Throughput**: > 1000 RPS por inst√¢ncia
- **Error Rate**: < 0.1%
- **Memory Usage**: < 512MB heap

## 8Ô∏è‚É£ Cobertura de Testes

### Verificar Cobertura
```bash
# Gerar relat√≥rio de cobertura
mvn clean test jacoco:report

# Ver relat√≥rio consolidado
mvn jacoco:report-aggregate
```

### Metas de Cobertura
- **Domain Layer**: 95%+
- **Application Layer**: 90%+
- **Infrastructure Layer**: 80%+
- **Overall**: 85%+

## 9Ô∏è‚É£ Testes com Postman

### Importar Cole√ß√£o
1. Abrir Postman
2. Importar `postman-collection.json`
3. Importar `postman-environment.json`
4. Executar testes na ordem:
   - Health Checks
   - Listar Produtos
   - Reservar Produto
   - Confirmar Reserva
   - Verificar Invent√°rio

### Executar Cole√ß√£o via CLI
```bash
# Instalar Newman (CLI do Postman)
npm install -g newman

# Executar cole√ß√£o completa
newman run postman-collection.json -e postman-environment.json

# Executar com relat√≥rio HTML
newman run postman-collection.json -e postman-environment.json -r htmlextra
```

## üîß Configura√ß√£o de Debugging

### Logs Detalhados
```bash
# Habilitar logs de debug
export LOGGING_LEVEL_COM_INVENTORY=DEBUG

# Debug espec√≠fico para SQL
export LOGGING_LEVEL_ORG_HIBERNATE_SQL=DEBUG

# Debug para retry e concorr√™ncia
export LOGGING_LEVEL_RETRY=DEBUG
```

### Remote Debugging
```bash
# Adicionar JVM args no Docker
JAVA_OPTS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=0.0.0.0:5005"

# Conectar IDE na porta 5005
```

## üìä M√©tricas de Teste

### Prometheus Queries para Testes
```promql
# Taxa de sucesso dos testes
rate(test_executions_total{result="success"}[5m])

# Lat√™ncia de testes de API
histogram_quantile(0.95, api_test_duration_seconds)

# Cobertura de c√≥digo
code_coverage_percentage{module="store-service"}
```

## ‚úÖ Checklist de Valida√ß√£o

Antes de considerar os testes completos, verifique:

- [ ] ‚úÖ Todos os testes unit√°rios passam
- [ ] ‚úÖ Testes de integra√ß√£o com containers funcionam
- [ ] ‚úÖ APIs respondem corretamente
- [ ] ‚úÖ Sistema de DLQ funciona (teste de resili√™ncia)
- [ ] ‚úÖ Controle de concorr√™ncia resolve conflitos
- [ ] ‚úÖ M√©tricas est√£o sendo coletadas
- [ ] ‚úÖ Logs estruturados est√£o funcionando
- [ ] ‚úÖ Performance est√° dentro dos SLAs
- [ ] ‚úÖ Cobertura de c√≥digo > 85%
- [ ] ‚úÖ Documenta√ß√£o est√° atualizada

## üöÄ CI/CD Integration

### GitHub Actions Example
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
      - name: Run tests
        run: |
          mvn clean test
          ./scripts/test-basic.sh
          ./scripts/test-resilience.sh
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

## üìû Suporte

Para problemas com testes:

1. üîç Verifique os logs: `docker-compose logs`
2. üß™ Execute teste isolado: `mvn test -Dtest=TestClass`
3. üêõ Use modo debug: `LOGGING_LEVEL_ROOT=DEBUG`
4. üìã Consulte a documenta√ß√£o espec√≠fica de cada componente

---

**üí° Dica**: Execute sempre `./scripts/test-basic.sh` antes de fazer commits para garantir que tudo est√° funcionando!
