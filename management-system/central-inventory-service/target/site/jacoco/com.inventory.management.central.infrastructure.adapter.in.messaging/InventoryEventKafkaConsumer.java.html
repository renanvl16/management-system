<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InventoryEventKafkaConsumer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Central Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.inventory.management.central.infrastructure.adapter.in.messaging</a> &gt; <span class="el_source">InventoryEventKafkaConsumer.java</span></div><h1>InventoryEventKafkaConsumer.java</h1><pre class="source lang-java linenums">package com.inventory.management.central.infrastructure.adapter.in.messaging;

import com.inventory.management.central.domain.model.InventoryEvent;
import com.inventory.management.central.domain.service.InventoryEventProcessingService;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.kafka.support.Acknowledgment;
import org.springframework.kafka.support.KafkaHeaders;
import org.springframework.messaging.handler.annotation.Header;
import org.springframework.messaging.handler.annotation.Payload;
import org.springframework.retry.annotation.Backoff;
import org.springframework.retry.annotation.Retryable;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;

/**
 * Consumidor Kafka para eventos de invent√°rio das lojas.
 * 
 * Este componente recebe eventos de atualiza√ß√£o de invent√°rio
 * das lojas via Kafka e os processa em tempo real para
 * manter o invent√°rio central sincronizado.
 * 
 * @author Sistema de Gerenciamento de Invent√°rio
 * @version 1.0.0
 * @since 1.0.0
 */
@Component
<span class="fc" id="L32">@RequiredArgsConstructor</span>
<span class="fc" id="L33">@Slf4j</span>
public class InventoryEventKafkaConsumer {
    
    private final InventoryEventProcessingService eventProcessingService;
    private final ObjectMapper objectMapper;
    
    /**
     * Consome eventos de invent√°rio do t√≥pico Kafka.
     * 
     * @param eventJson JSON do evento
     * @param partition parti√ß√£o da mensagem
     * @param offset offset da mensagem
     * @param timestamp timestamp da mensagem
     * @param acknowledgment acknowledgment para confirma√ß√£o manual
     */
    @KafkaListener(
        topics = &quot;${app.kafka.topics.inventory-update:inventory-update}&quot;,
        groupId = &quot;${app.kafka.consumer.group-id:central-inventory-group}&quot;,
        containerFactory = &quot;kafkaListenerContainerFactory&quot;
    )
    @Retryable(
        retryFor = {Exception.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2.0)
    )
    public void consumeInventoryEvent(
            @Payload String eventJson,
            @Header(KafkaHeaders.RECEIVED_PARTITION) int partition,
            @Header(KafkaHeaders.OFFSET) long offset,
            @Header(KafkaHeaders.RECEIVED_TIMESTAMP) long timestamp,
            Acknowledgment acknowledgment) {
        
<span class="fc" id="L65">        log.info(&quot;üì• Evento recebido: partition={}, offset={}, timestamp={}&quot;, </span>
<span class="fc" id="L66">                partition, offset, LocalDateTime.now());</span>
        
        try {
            // Deserializar evento
<span class="fc" id="L70">            InventoryEvent event = deserializeEvent(eventJson);</span>
            
<span class="fc" id="L72">            log.debug(&quot;üîç Evento deserializado: eventId={}, tipo={}, produto={}, loja={}&quot;, </span>
<span class="fc" id="L73">                    event.getEventId(), event.getEventType(), event.getProductSku(), event.getStoreId());</span>
            
            // Processar evento
<span class="fc" id="L76">            boolean processed = eventProcessingService.processInventoryEvent(event);</span>
            
<span class="fc bfc" id="L78" title="All 2 branches covered.">            if (processed) {</span>
<span class="fc" id="L79">                log.info(&quot;‚úÖ Evento processado com sucesso: eventId={}&quot;, event.getEventId());</span>
                
                // Confirmar processamento (commit manual)
<span class="fc" id="L82">                acknowledgment.acknowledge();</span>
                
            } else {
<span class="fc" id="L85">                log.error(&quot;‚ùå Falha no processamento do evento: eventId={}&quot;, event.getEventId());</span>
                
                // N√£o fazer acknowledge - deixar para retry ou DLQ
<span class="fc" id="L88">                throw new EventProcessingException(</span>
<span class="fc" id="L89">                        &quot;Falha no processamento do evento: &quot; + event.getEventId());</span>
            }
            
<span class="fc" id="L92">        } catch (Exception e) {</span>
<span class="fc" id="L93">            log.error(&quot;üíÄ Erro cr√≠tico no consumo do evento: partition={}, offset={}, erro={}&quot;, </span>
<span class="fc" id="L94">                    partition, offset, e.getMessage(), e);</span>
            
            // Re-lan√ßar para acionar retry ou enviar para DLQ
<span class="fc" id="L97">            throw new EventProcessingException(&quot;Erro cr√≠tico no processamento&quot;, e);</span>
<span class="fc" id="L98">        }</span>
<span class="fc" id="L99">    }</span>
    
    /**
     * Deserializa o JSON do evento para objeto InventoryEvent.
     * 
     * @param eventJson JSON do evento
     * @return evento deserializado
     * @throws EventDeserializationException se houver erro na deserializa√ß√£o
     */
    private InventoryEvent deserializeEvent(String eventJson) {
        try {
            // Registrar m√≥dulo para LocalDateTime se necess√°rio
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            if (objectMapper.findAndRegisterModules() != null) {</span>
<span class="nc" id="L112">                objectMapper.registerModule(new JavaTimeModule());</span>
            }
            
<span class="fc" id="L115">            return objectMapper.readValue(eventJson, InventoryEvent.class);</span>
            
<span class="fc" id="L117">        } catch (Exception e) {</span>
<span class="fc" id="L118">            log.error(&quot;‚ùå Erro na deserializa√ß√£o do evento: json={}, erro={}&quot;, eventJson, e.getMessage());</span>
<span class="fc" id="L119">            throw new EventDeserializationException(&quot;Falha na deserializa√ß√£o do evento&quot;, e);</span>
        }
    }
    
    /**
     * Exception para erros de processamento de eventos.
     */
    public static class EventProcessingException extends RuntimeException {
        public EventProcessingException(String message) {
<span class="fc" id="L128">            super(message);</span>
<span class="fc" id="L129">        }</span>
        
        public EventProcessingException(String message, Throwable cause) {
<span class="fc" id="L132">            super(message, cause);</span>
<span class="fc" id="L133">        }</span>
    }
    
    /**
     * Exception para erros de deserializa√ß√£o de eventos.
     */
    public static class EventDeserializationException extends RuntimeException {
        public EventDeserializationException(String message, Throwable cause) {
<span class="fc" id="L141">            super(message, cause);</span>
<span class="fc" id="L142">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>