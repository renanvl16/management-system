<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RateLimitConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Central Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.inventory.management.central.infrastructure.config</a> &gt; <span class="el_source">RateLimitConfig.java</span></div><h1>RateLimitConfig.java</h1><pre class="source lang-java linenums">package com.inventory.management.central.infrastructure.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.script.DefaultRedisScript;
import org.springframework.data.redis.serializer.StringRedisSerializer;

import java.time.Duration;
import java.util.List;

/**
 * Configuração de Rate Limiting usando Redis para Central Inventory Service.
 * 
 * @author System
 * @version 1.0.0
 */
@Configuration
<span class="fc" id="L21">@Slf4j</span>
<span class="fc" id="L22">public class RateLimitConfig {</span>
    
    @Bean
    public RedisTemplate&lt;String, String&gt; rateLimitRedisTemplate(RedisConnectionFactory connectionFactory) {
<span class="fc" id="L26">        RedisTemplate&lt;String, String&gt; template = new RedisTemplate&lt;&gt;();</span>
<span class="fc" id="L27">        template.setConnectionFactory(connectionFactory);</span>
<span class="fc" id="L28">        template.setKeySerializer(new StringRedisSerializer());</span>
<span class="fc" id="L29">        template.setValueSerializer(new StringRedisSerializer());</span>
<span class="fc" id="L30">        template.setHashKeySerializer(new StringRedisSerializer());</span>
<span class="fc" id="L31">        template.setHashValueSerializer(new StringRedisSerializer());</span>
<span class="fc" id="L32">        template.afterPropertiesSet();</span>
<span class="fc" id="L33">        return template;</span>
    }
    
    @Bean
    public DefaultRedisScript&lt;Long&gt; rateLimitScript() {
<span class="fc" id="L38">        DefaultRedisScript&lt;Long&gt; script = new DefaultRedisScript&lt;&gt;();</span>
<span class="fc" id="L39">        script.setScriptText(&quot;&quot;&quot;</span>
            local key = KEYS[1]
            local window = tonumber(ARGV[1])
            local limit = tonumber(ARGV[2])
            local current_time = tonumber(ARGV[3])
            
            -- Clean old entries
            redis.call('ZREMRANGEBYSCORE', key, 0, current_time - window * 1000)
            
            -- Count current requests
            local current = redis.call('ZCARD', key)
            
            if current &lt; limit then
                -- Add current request
                redis.call('ZADD', key, current_time, current_time)
                redis.call('EXPIRE', key, window)
                return limit - current - 1
            else
                return -1
            end
            &quot;&quot;&quot;);
<span class="fc" id="L60">        script.setResultType(Long.class);</span>
<span class="fc" id="L61">        return script;</span>
    }
    
    @Bean
    public RateLimiter rateLimiter(RedisTemplate&lt;String, String&gt; rateLimitRedisTemplate, 
                                   DefaultRedisScript&lt;Long&gt; rateLimitScript) {
<span class="fc" id="L67">        return new RateLimiter(rateLimitRedisTemplate, rateLimitScript);</span>
    }
    
    public static class RateLimiter {
        private final RedisTemplate&lt;String, String&gt; redisTemplate;
        private final DefaultRedisScript&lt;Long&gt; script;
        
<span class="fc" id="L74">        public RateLimiter(RedisTemplate&lt;String, String&gt; redisTemplate, DefaultRedisScript&lt;Long&gt; script) {</span>
<span class="fc" id="L75">            this.redisTemplate = redisTemplate;</span>
<span class="fc" id="L76">            this.script = script;</span>
<span class="fc" id="L77">        }</span>
        
        public boolean isAllowed(String key, int limit, Duration window) {
<span class="fc" id="L80">            long currentTime = System.currentTimeMillis();</span>
<span class="fc" id="L81">            String redisKey = &quot;rate_limit:&quot; + key;</span>
            
            try {
<span class="fc" id="L84">                Long result = redisTemplate.execute(script, </span>
<span class="fc" id="L85">                    List.of(redisKey), </span>
<span class="fc" id="L86">                    String.valueOf(window.getSeconds()), </span>
<span class="fc" id="L87">                    String.valueOf(limit), </span>
<span class="fc" id="L88">                    String.valueOf(currentTime));</span>
                
<span class="fc bfc" id="L90" title="All 4 branches covered.">                return result != null &amp;&amp; result &gt;= 0;</span>
<span class="fc" id="L91">            } catch (Exception e) {</span>
<span class="fc" id="L92">                log.error(&quot;Rate limiting failed for key: {}&quot;, key, e);</span>
                // Fail open - allow request if Redis is down
<span class="fc" id="L94">                return true;</span>
            }
        }
        
        public long getRemainingRequests(String key, int limit, Duration window) {
<span class="fc" id="L99">            long currentTime = System.currentTimeMillis();</span>
<span class="fc" id="L100">            String redisKey = &quot;rate_limit:&quot; + key;</span>
            
            try {
<span class="fc" id="L103">                Long result = redisTemplate.execute(script, </span>
<span class="fc" id="L104">                    List.of(redisKey), </span>
<span class="fc" id="L105">                    String.valueOf(window.getSeconds()), </span>
<span class="fc" id="L106">                    String.valueOf(limit), </span>
<span class="fc" id="L107">                    String.valueOf(currentTime));</span>
                
<span class="fc bfc" id="L109" title="All 2 branches covered.">                return result != null ? Math.max(0, result) : limit;</span>
<span class="fc" id="L110">            } catch (Exception e) {</span>
<span class="fc" id="L111">                log.error(&quot;Failed to get remaining requests for key: {}&quot;, key, e);</span>
<span class="fc" id="L112">                return limit;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>