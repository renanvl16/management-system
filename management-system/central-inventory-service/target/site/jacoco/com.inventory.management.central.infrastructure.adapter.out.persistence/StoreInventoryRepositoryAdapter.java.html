<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StoreInventoryRepositoryAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Central Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.inventory.management.central.infrastructure.adapter.out.persistence</a> &gt; <span class="el_source">StoreInventoryRepositoryAdapter.java</span></div><h1>StoreInventoryRepositoryAdapter.java</h1><pre class="source lang-java linenums">package com.inventory.management.central.infrastructure.adapter.out.persistence;

import com.inventory.management.central.domain.model.StoreInventory;
import com.inventory.management.central.domain.port.StoreInventoryRepository;
import com.inventory.management.central.infrastructure.adapter.out.persistence.StoreInventoryJpaEntity.StoreInventoryId;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * Implementa√ß√£o JPA do reposit√≥rio de invent√°rio por loja.
 * 
 * @author Sistema de Gerenciamento de Invent√°rio
 * @version 1.0.0
 * @since 1.0.0
 */
@Component
<span class="fc" id="L24">@RequiredArgsConstructor</span>
<span class="fc" id="L25">@Slf4j</span>
public class StoreInventoryRepositoryAdapter implements StoreInventoryRepository {
    
    private final StoreInventoryJpaRepository jpaRepository;
    
    @Override
    public StoreInventory save(StoreInventory storeInventory) {
        try {
<span class="fc" id="L33">            log.debug(&quot;üíæ Salvando StoreInventory: sku={}, storeId={}&quot;, </span>
<span class="fc" id="L34">                    storeInventory.getProductSku(), storeInventory.getStoreId());</span>
            
<span class="fc" id="L36">            StoreInventoryJpaEntity entity = toEntity(storeInventory);</span>
            
            // Verificar se j√° existe
<span class="fc" id="L39">            StoreInventoryJpaEntity existing = jpaRepository</span>
<span class="fc" id="L40">                    .findByIdProductSkuAndIdStoreId(entity.getProductSku(), entity.getStoreId());</span>
            
            StoreInventoryJpaEntity savedEntity;
            
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">            if (existing != null) {</span>
                // Atualizar entidade existente
<span class="nc" id="L46">                existing.setQuantity(entity.getQuantity());</span>
<span class="nc" id="L47">                existing.setReserved(entity.getReserved());</span>
<span class="nc" id="L48">                existing.setAvailable(entity.getAvailable());</span>
<span class="nc" id="L49">                existing.setLastUpdated(entity.getLastUpdated());</span>
<span class="nc" id="L50">                existing.setIsSynchronized(entity.getIsSynchronized());</span>
<span class="nc" id="L51">                existing.setVersion(existing.getVersion() + 1);</span>
                
<span class="nc" id="L53">                savedEntity = jpaRepository.save(existing);</span>
<span class="nc" id="L54">                log.debug(&quot;‚úÖ StoreInventory atualizado: sku={}&quot;, storeInventory.getProductSku());</span>
            } else {
                // Criar novo
<span class="fc" id="L57">                savedEntity = jpaRepository.save(entity);</span>
<span class="fc" id="L58">                log.debug(&quot;‚úÖ StoreInventory criado: sku={}&quot;, storeInventory.getProductSku());</span>
            }
            
<span class="fc" id="L61">            return toDomain(savedEntity);</span>
            
<span class="nc" id="L63">        } catch (Exception ex) {</span>
<span class="nc" id="L64">            log.error(&quot;‚ùå Erro ao salvar StoreInventory: sku={}, storeId={}, erro={}&quot;, </span>
<span class="nc" id="L65">                    storeInventory.getProductSku(), storeInventory.getStoreId(), ex.getMessage());</span>
<span class="nc" id="L66">            throw new RuntimeException(&quot;Falha ao salvar invent√°rio da loja&quot;, ex);</span>
        }
    }
    
    @Override
    @Transactional(readOnly = true)
    public Optional&lt;StoreInventory&gt; findByProductSkuAndStoreId(String productSku, String storeId) {
<span class="fc" id="L73">        log.debug(&quot;üîç Buscando invent√°rio: productSku={}, storeId={}&quot;, productSku, storeId);</span>
        
<span class="fc" id="L75">        StoreInventoryJpaEntity entity = jpaRepository.findByIdProductSkuAndIdStoreId(productSku, storeId);</span>
        
<span class="fc" id="L77">        return Optional.ofNullable(entity).map(this::toDomain);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;StoreInventory&gt; findByProductSku(String productSku) {
<span class="fc" id="L83">        log.debug(&quot;üîç Buscando por produto: productSku={}&quot;, productSku);</span>
        
<span class="fc" id="L85">        return jpaRepository.findByIdProductSku(productSku)</span>
<span class="fc" id="L86">                           .stream()</span>
<span class="fc" id="L87">                           .map(this::toDomain)</span>
<span class="fc" id="L88">                           .toList();</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;StoreInventory&gt; findByStoreId(String storeId) {
<span class="fc" id="L94">        log.debug(&quot;üîç Buscando por loja: storeId={}&quot;, storeId);</span>
        
<span class="fc" id="L96">        return jpaRepository.findByIdStoreId(storeId)</span>
<span class="fc" id="L97">                           .stream()</span>
<span class="fc" id="L98">                           .map(this::toDomain)</span>
<span class="fc" id="L99">                           .toList();</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;StoreInventory&gt; findAll() {
<span class="fc" id="L105">        log.debug(&quot;üìã Listando todos os invent√°rios por loja&quot;);</span>
        
<span class="fc" id="L107">        return jpaRepository.findAll()</span>
<span class="fc" id="L108">                           .stream()</span>
<span class="fc" id="L109">                           .map(this::toDomain)</span>
<span class="fc" id="L110">                           .toList();</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;StoreInventory&gt; findWithAvailableStock() {
<span class="fc" id="L116">        log.debug(&quot;üì¶ Buscando invent√°rios com estoque dispon√≠vel&quot;);</span>
        
<span class="fc" id="L118">        return jpaRepository.findWithAvailableStock()</span>
<span class="fc" id="L119">                           .stream()</span>
<span class="fc" id="L120">                           .map(this::toDomain)</span>
<span class="fc" id="L121">                           .toList();</span>
    }
    
    @Override
    public List&lt;StoreInventory&gt; findUnsynchronized() {
<span class="fc" id="L126">        log.debug(&quot;Buscando invent√°rios n√£o sincronizados&quot;);</span>
<span class="fc" id="L127">        return jpaRepository.findByIsSynchronizedFalse()</span>
<span class="fc" id="L128">                .stream()</span>
<span class="fc" id="L129">                .map(this::toDomain)</span>
<span class="fc" id="L130">                .collect(Collectors.toList());</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;StoreInventory&gt; findByStoreIdWithAvailableStock(String storeId) {
<span class="fc" id="L136">        log.debug(&quot;üì¶ Buscando invent√°rios com estoque na loja: storeId={}&quot;, storeId);</span>
        
<span class="fc" id="L138">        return jpaRepository.findByStoreIdWithAvailableStock(storeId)</span>
<span class="fc" id="L139">                           .stream()</span>
<span class="fc" id="L140">                           .map(this::toDomain)</span>
<span class="fc" id="L141">                           .toList();</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public Integer sumQuantityByProductSku(String productSku) {
<span class="fc" id="L147">        log.debug(&quot;üßÆ Calculando quantidade total: productSku={}&quot;, productSku);</span>
        
<span class="fc" id="L149">        Integer total = jpaRepository.sumQuantityByProductSku(productSku);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">        return total != null ? total : 0;</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public Integer sumReservedQuantityByProductSku(String productSku) {
<span class="fc" id="L156">        log.debug(&quot;üßÆ Calculando quantidade reservada total: productSku={}&quot;, productSku);</span>
        
<span class="fc" id="L158">        Integer total = jpaRepository.sumReservedQuantityByProductSku(productSku);</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        return total != null ? total : 0;</span>
    }
    
    @Override
    @Transactional
    public void deleteByProductSkuAndStoreId(String productSku, String storeId) {
<span class="fc" id="L165">        log.debug(&quot;üóëÔ∏è  Removendo invent√°rio: productSku={}, storeId={}&quot;, productSku, storeId);</span>
        
<span class="fc" id="L167">        StoreInventoryId id = new StoreInventoryId(productSku, storeId);</span>
<span class="fc" id="L168">        jpaRepository.deleteById(id);</span>
<span class="fc" id="L169">    }</span>
    
    @Override
    @Transactional
    public void deleteByProductSku(String productSku) {
<span class="fc" id="L174">        log.debug(&quot;üóëÔ∏è  Removendo invent√°rios do produto: productSku={}&quot;, productSku);</span>
        
<span class="fc" id="L176">        jpaRepository.deleteByIdProductSku(productSku);</span>
<span class="fc" id="L177">    }</span>
    
    @Override
    @Transactional
    public void deleteByStoreId(String storeId) {
<span class="fc" id="L182">        log.debug(&quot;üóëÔ∏è  Removendo invent√°rios da loja: storeId={}&quot;, storeId);</span>
        
<span class="fc" id="L184">        jpaRepository.deleteByIdStoreId(storeId);</span>
<span class="fc" id="L185">    }</span>
    
    @Override
    @Transactional(readOnly = true)
    public boolean existsByProductSkuAndStoreId(String productSku, String storeId) {
<span class="fc" id="L190">        log.debug(&quot;‚ùì Verificando exist√™ncia: productSku={}, storeId={}&quot;, productSku, storeId);</span>
        
<span class="fc" id="L192">        return jpaRepository.existsByIdProductSkuAndIdStoreId(productSku, storeId);</span>
    }
    
    @Override
    @Transactional
    public Optional&lt;StoreInventory&gt; updateQuantities(String productSku, String storeId, 
                                                   Integer quantity, Integer reservedQuantity) {
<span class="fc" id="L199">        log.debug(&quot;üîÑ Atualizando quantidades: productSku={}, storeId={}, quantity={}, reserved={}&quot;, </span>
                productSku, storeId, quantity, reservedQuantity);
        
<span class="fc" id="L202">        int updatedRows = jpaRepository.updateQuantities(productSku, storeId, quantity, reservedQuantity);</span>
        
<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (updatedRows &gt; 0) {</span>
<span class="fc" id="L205">            return findByProductSkuAndStoreId(productSku, storeId);</span>
        }
        
<span class="fc" id="L208">        return Optional.empty();</span>
    }
    
    /**
     * Converte entidade JPA para dom√≠nio.
     */
    private StoreInventory toDomain(StoreInventoryJpaEntity entity) {
<span class="fc" id="L215">        return StoreInventory.builder()</span>
<span class="fc" id="L216">                .productSku(entity.getId().getProductSku())</span>
<span class="fc" id="L217">                .storeId(entity.getId().getStoreId())</span>
<span class="fc" id="L218">                .storeName(entity.getStoreName())</span>
<span class="fc" id="L219">                .storeLocation(entity.getStoreLocation())</span>
<span class="fc" id="L220">                .quantity(entity.getQuantity())</span>
<span class="fc" id="L221">                .reservedQuantity(entity.getReservedQuantity())</span>
<span class="fc" id="L222">                .availableQuantity(entity.getAvailableQuantity())</span>
<span class="fc" id="L223">                .lastUpdated(entity.getLastUpdated())</span>
<span class="fc" id="L224">                .lastSyncTime(entity.getLastSyncTime())</span>
<span class="fc" id="L225">                .isSynchronized(entity.getIsSynchronized())</span>
<span class="fc" id="L226">                .build();</span>
    }
    
    /**
     * Converte dom√≠nio para entidade JPA.
     */
    private StoreInventoryJpaEntity toEntity(StoreInventory domain) {
<span class="fc" id="L233">        StoreInventoryId id = new StoreInventoryId(domain.getProductSku(), domain.getStoreId());</span>
        
<span class="fc" id="L235">        return StoreInventoryJpaEntity.builder()</span>
<span class="fc" id="L236">                .id(id)</span>
<span class="fc" id="L237">                .storeName(domain.getStoreName())</span>
<span class="fc" id="L238">                .storeLocation(domain.getStoreLocation())</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">                .quantity(domain.getQuantity() != null ? domain.getQuantity() : 0)</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">                .reserved(domain.getReservedQuantity() != null ? domain.getReservedQuantity() : 0)</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">                .available(domain.getAvailableQuantity() != null ? domain.getAvailableQuantity() : 0)</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">                .lastUpdated(domain.getLastUpdated() != null ? domain.getLastUpdated() : LocalDateTime.now())</span>
<span class="fc" id="L243">                .lastSyncTime(domain.getLastSyncTime())</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">                .isSynchronized(domain.getIsSynchronized() != null ? domain.getIsSynchronized() : Boolean.FALSE)</span>
<span class="fc" id="L245">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>